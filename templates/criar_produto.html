{% extends "base.html" %}
{% block title %}Criar Novo Produto{% endblock %}
{% block content %}
<div class="card">
    <h1>Criar Novo Produto Vendável</h1>
    <p>Um produto é o que você vende. Ele pode ser composto por uma ou mais receitas (ou frações delas).</p>
    
    <form id="form-produto" method="POST">
        <input type="hidden" name="composicao_json" id="composicao_json">

        <div class="form-row">
            <div class="form-group" style="flex: 2;">
                <label for="nome">Nome do Produto</label>
                <input type="text" name="nome" placeholder="Ex: Brigadeiro Tradicional (unidade), Caixinha com 5">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="preco_venda">Preço de Venda (R$)</label>
                <input type="number" name="preco_venda" step="0.01">
            </div>
        </div>

        <hr>
        <h4>Composição do Produto</h4>
        <div id="composicao-container"></div>

        <div class="form-row" style="align-items: flex-end; border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
            <div class="form-group" style="flex: 3;">
                <label>Adicionar Receita à Composição</label>
                <select id="receita_select">
                    <option value="">Selecione uma receita</option>
                    {% for r in receitas %}
                    <option value="{{ r['id'] }}" data-nome="{{ r['nome'] }}" data-rendimento="{{ r['rendimento'] }}">{{ r['nome'] }} (rende {{ r['rendimento'] }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Unidades da Receita</label>
                <input type="number" id="unidades_receita" value="1" min="1">
            </div>
            <div class="form-group">
                <button type="button" id="add-comp-btn" class="btn btn-secondary">Adicionar</button>
            </div>
        </div>

        <div class="nav-buttons">
            <button type="submit" class="btn btn-primary">Salvar Produto</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const composicao = [];
    
    function renderComposicao() {
        // Lógica JavaScript para gerir a lista de composição (semelhante ao form de vendas)
    }

    document.getElementById('add-comp-btn').addEventListener('click', () => {
        const select = document.getElementById('receita_select');
        const option = select.options[select.selectedIndex];
        const receitaId = parseInt(option.value);
        const nome = option.dataset.nome;
        const rendimento = parseInt(option.dataset.rendimento);
        const unidades = parseInt(document.getElementById('unidades_receita').value);

        if (!receitaId || !unidades) return;
        
        const fracao = unidades / rendimento;
        
        composicao.push({
            receita_id: receitaId,
            nome: nome,
            fracao: fracao,
            texto: `${unidades} de ${rendimento} da receita '${nome}'`
        });
        
        renderComposicao(); // Esta função precisa de ser implementada para mostrar os itens
        document.getElementById('composicao_json').value = JSON.stringify(composicao);
    });
</script>
{% endblock %}